generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ClType { 
  PPTO 
  RPPTO 
  GASTO 
  PROVISION 
}

enum ClState { 
  NO_PROCESADO 
  PROCESADO 
  PROVISIONADO 
}

enum InvStatus {
  INGRESADO 
  EN_APROBACION       // DEPRECATED: usar APROBACION_HEAD o APROBACION_VP
  APROBACION_HEAD     // Nueva: Aprobación por Head (primer nivel)
  APROBACION_VP       // Nueva: Aprobación por VP (segundo nivel, si supera umbral)
  EN_CONTABILIDAD 
  EN_TESORERIA 
  EN_ESPERA_DE_PAGO 
  PAGADO 
  RECHAZADO
}

enum InvDocType { 
  FACTURA 
  NOTA_CREDITO 
}

enum ExpenseType {
  ADMINISTRATIVO
  PRODUCTO
  DISTRIBUIBLE
}

enum OcStatus {
  PENDIENTE
  PROCESAR
  EN_PROCESO
  PROCESADO
  APROBACION_VP
  ANULAR
  ANULADO
  ATENDER_COMPRAS
  ATENDIDO
}

enum DocumentCategory {
  COTIZACION
  FACTURA
  CONTRATO
  OTRO
}

model Period {
  id      Int     @id @default(autoincrement())
  year    Int
  month   Int
  label   String?
  // relaciones
  controlLines_period        ControlLine[] @relation("CL_PERIOD")
  controlLines_accountPeriod ControlLine[] @relation("CL_ACCOUNTING_PERIOD")
  closures AccountingClosure?
  budgetAllocations BudgetAllocation[]
  oc_periodFrom OC[] @relation("OC_PERIOD_FROM")
  oc_periodTo   OC[] @relation("OC_PERIOD_TO")
  invoicePeriods InvoicePeriod[] @relation("InvoicePeriod")
}

model AccountingClosure {
  id         Int     @id @default(autoincrement())
  periodId   Int     @unique
  period     Period  @relation(fields: [periodId], references: [id])
  receivedAt DateTime?
  sourceRef  String?
}

model FxReference {
  id            Int      @id @default(autoincrement())
  currency      String   // 'PEN' | 'USD'
  rate          Decimal
  effectiveFrom DateTime
  effectiveTo   DateTime?
}

model ExchangeRate {
  id   Int     @id @default(autoincrement())
  year Int     @unique
  rate Decimal
}

model ApprovalThreshold {
  id            Int      @id @default(autoincrement())
  key           String   @unique  // 'INVOICE_VP_THRESHOLD' para facturas
  description   String?            // Descripción del umbral
  amountPEN     Decimal            // Monto umbral en Soles (PEN) con IGV
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Support {
  id               Int      @id @default(autoincrement())
  code             String?  @unique
  name             String   @unique
  management       String?  // DEPRECATED: usar managementId
  area             String?  // DEPRECATED: usar areaId
  active           Boolean  @default(true)

  managementId     Int?
  managementRef    Management?        @relation(fields: [managementId], references: [id])

  areaId           Int?
  areaRef          Area?              @relation(fields: [areaId], references: [id])

  costCenterId     Int?  // DEPRECATED: usar costCenters (M:N)
  costCenter       CostCenter?        @relation("LegacySupportCostCenter", fields: [costCenterId], references: [id])

  expensePackageId Int?
  expensePackage   ExpensePackage?    @relation(fields: [expensePackageId], references: [id])

  expenseConceptId Int?
  expenseConcept   ExpenseConcept?    @relation(fields: [expenseConceptId], references: [id])

  expenseType      ExpenseType @default(ADMINISTRATIVO)

  vendorId         Int?

  // relaciones
  budgetAllocations BudgetAllocation[]
  controlLines      ControlLine[]
  ocs               OC[]
  invoices          Invoice[]            // Facturas sin OC asociadas
  costCenters       SupportCostCenter[]  // M:N con CostCenter
  provisions        Provision[]          // Provisiones asociadas
  recursosTercerizados RecursoTercerizado[]  // Recursos tercerizados asociados
}

model CostCenter {
  id       Int       @id @default(autoincrement())
  code     String    @unique
  name     String?
  supports Support[] @relation("LegacySupportCostCenter")  // DEPRECATED: relación 1:N legacy
  ocs      OC[]      @relation("LegacyOCCostCenter")       // DEPRECATED: relación 1:N legacy
  supportLinks SupportCostCenter[]  // M:N con Support
  ocLinks  OCCostCenter[]           // M:N con OC
  invoiceLinks InvoiceCostCenter[] @relation("InvoiceCostCenter")  // M:N con Invoice
  budgetAllocations BudgetAllocation[]
}

model Articulo {
  id   Int    @id @default(autoincrement())
  code String @unique
  name String
  ocs  OC[]
}

model Management {
  id       Int       @id @default(autoincrement())
  code     String?   // DEPRECATED: usar name directamente
  name     String    // Unicidad case-insensitive via índice
  active   Boolean   @default(true)
  supports Support[]
  areas    Area[]
  recursosTercerizados RecursoTercerizado[]
}

model Area {
  id           Int         @id @default(autoincrement())
  code         String?     // DEPRECATED: usar name directamente
  name         String      // Unicidad case-insensitive via índice
  managementId Int
  management   Management  @relation(fields: [managementId], references: [id], onDelete: Cascade)
  active       Boolean     @default(true)
  supports     Support[]
}

model ExpensePackage {
  id        Int              @id @default(autoincrement())
  name      String
  supports  Support[]
  concepts  ExpenseConcept[]
}

model ExpenseConcept {
  id        Int             @id @default(autoincrement())
  name      String
  packageId Int
  package   ExpensePackage  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  supports  Support[]
}

model BudgetVersion {
  id     Int     @id @default(autoincrement())
  name   String
  status String   // 'ACTIVE' | 'DRAFT' | 'ARCHIVED'
  allocs BudgetAllocation[]
}

model BudgetAllocation {
  id           Int     @id @default(autoincrement())
  versionId    Int
  version      BudgetVersion @relation(fields: [versionId], references: [id])
  supportId    Int
  support      Support @relation(fields: [supportId], references: [id], onDelete: Cascade)
  costCenterId Int?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id], onDelete: Cascade)
  periodId     Int
  period       Period  @relation(fields: [periodId], references: [id])
  amountLocal  Decimal
  currency     String  @default("PEN")
  
  // Tipo de presupuesto: PPTO (original) o RPPTO (revisado)
  // Permite mantener ambos tipos para un mismo año, período y sustento
  budgetType   String  @default("PPTO") // 'PPTO' | 'RPPTO'

  @@unique([versionId, periodId, supportId, costCenterId, budgetType], name: "ux_alloc_version_period_support_ceco_type")
  @@index([periodId, costCenterId], name: "ix_alloc_period_ceco")
  @@index([budgetType], name: "ix_alloc_budget_type")
}

model Vendor {
  id        Int     @id @default(autoincrement())
  legalName String
  taxId     String? @unique
  // relaciones
  purchaseOrders PurchaseOrder[]
  invoices       Invoice[]
}

// ============ PROVEEDORES ============
// Entidad central para gestión de proveedores en todo el sistema
model Proveedor {
  id          Int      @id @default(autoincrement())
  razonSocial String   // Nombre o razón social del proveedor
  ruc         String   @unique  // RUC (11 dígitos, único)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relaciones
  ocs         OC[]      @relation("OC_PROVEEDOR")
  invoices    Invoice[] // Facturas sin OC asociadas
  recursosTercerizados RecursoTercerizado[]
  
  @@index([ruc], name: "ix_proveedor_ruc")
  @@index([razonSocial], name: "ix_proveedor_razon_social")
}

model PurchaseOrder {
  id       Int     @id @default(autoincrement())
  number   String  @unique
  vendorId Int?
  vendor   Vendor? @relation(fields: [vendorId], references: [id])
  incCode  String?
  // relaciones
  controlLines ControlLine[]
}

model Invoice {
  id              Int        @id @default(autoincrement())
  
  // NUEVO: Relación con OC (requerido para nuevas facturas)
  ocId            Int?
  oc              OC?        @relation(fields: [ocId], references: [id], onDelete: SetNull)
  
  // NUEVO: Relación con Support (para facturas sin OC)
  supportId       Int?
  support         Support?   @relation(fields: [supportId], references: [id], onDelete: SetNull)
  
  // NUEVO: Relación con Proveedor (para facturas sin OC)
  proveedorId     Int?
  proveedor       Proveedor? @relation(fields: [proveedorId], references: [id], onDelete: SetNull)
  
  // DEPRECATED: vendorId ahora se deriva de OC
  vendorId        Int?
  vendor          Vendor?    @relation(fields: [vendorId], references: [id])
  
  docType         InvDocType @default(FACTURA)
  numberNorm      String?
  
  // Moneda se hereda de la OC
  currency        String     @default("PEN")  // 'PEN' | 'USD'
  
  // NUEVO: Monto principal (sin IGV)
  montoSinIgv     Decimal?
  
  // NUEVO: Tipo de cambio override (opcional, para sobrescribir el anual)
  exchangeRateOverride Decimal?
  
  // DEPRECATED: campos legacy (mantener para compatibilidad)
  totalForeign    Decimal?   // negativo si NOTA_CREDITO
  totalLocal      Decimal?   // negativo si NOTA_CREDITO
  
  // === CAMPOS CONTABLES ===
  mesContable          String?   // Formato YYYY-MM
  tcEstandar           Decimal?  // TC estándar según catálogo
  tcReal               Decimal?  // TC real (editable por usuario)
  montoPEN_tcEstandar  Decimal?  // montoSinIgv * tcEstandar
  montoPEN_tcReal      Decimal?  // montoSinIgv * tcReal
  diferenciaTC         Decimal?  // montoPEN_tcReal - montoPEN_tcEstandar
  
  statusCurrent   InvStatus  @default(INGRESADO)
  ultimusIncident String?    // Incidente Ultimus
  detalle         String?    @db.Text
  approvedAt      DateTime?
  
  // Auditoría de usuarios
  createdBy       Int?       // Usuario que creó la factura
  createdByUser   User?      @relation("InvoiceCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  approvedBy      Int?       // Usuario que aprobó la factura
  approvedByUser  User?      @relation("InvoiceApprovedBy", fields: [approvedBy], references: [id], onDelete: SetNull)
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  statusHistory   InvoiceStatusHistory[]
  controlLines    ControlLine[]
  periods         InvoicePeriod[]         // M:N con Period (meses de registro)
  costCenters     InvoiceCostCenter[]     // M:N con CostCenter (distribución)
  
  @@index([ocId], name: "ix_invoice_oc")
}

model InvoiceStatusHistory {
  id        Int       @id @default(autoincrement())
  invoiceId Int
  invoice   Invoice   @relation(fields: [invoiceId], references: [id])
  status    InvStatus
  changedAt DateTime  @default(now())
  changedBy Int?
  note      String?
}

// Tabla pivot: Factura ↔ Periodo (meses de registro)
model InvoicePeriod {
  id        Int      @id @default(autoincrement())
  invoiceId Int
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  periodId  Int
  period    Period   @relation("InvoicePeriod", fields: [periodId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([invoiceId, periodId], name: "ux_invoice_period_pair")
  @@index([invoiceId], name: "ix_invoiceperiod_invoice")
  @@index([periodId], name: "ix_invoiceperiod_period")
}

// Tabla pivot: Factura ↔ CostCenter (distribución)
model InvoiceCostCenter {
  id           Int        @id @default(autoincrement())
  invoiceId    Int
  invoice      Invoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  costCenterId Int
  costCenter   CostCenter @relation("InvoiceCostCenter", fields: [costCenterId], references: [id], onDelete: Cascade)
  amount       Decimal?   // Monto asignado a este CECO
  percentage   Decimal?   // Porcentaje asignado (0-100)
  createdAt    DateTime   @default(now())

  @@unique([invoiceId, costCenterId], name: "ux_invoice_costcenter_pair")
  @@index([invoiceId], name: "ix_invoicecostcenter_invoice")
  @@index([costCenterId], name: "ix_invoicecostcenter_costcenter")
}

model ControlLine {
  id        Int      @id @default(autoincrement())
  supportId Int
  support   Support  @relation(fields: [supportId], references: [id], onDelete: Cascade)

  type  ClType
  state ClState @default(NO_PROCESADO)

  periodId Int
  period   Period @relation("CL_PERIOD", fields: [periodId], references: [id])

  accountingPeriodId Int?
  accountingPeriod   Period? @relation("CL_ACCOUNTING_PERIOD", fields: [accountingPeriodId], references: [id])

  invoiceId Int?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])

  poId Int?
  po   PurchaseOrder? @relation(fields: [poId], references: [id])

  description   String?

  // Moneda y TC
  currency          String?      // 'PEN' | 'USD'
  amountForeign     Decimal?
  fxRateProvisional Decimal? @default(1.0) // asignada al crear (USD usa FxReference; PEN=1)
  fxRateFinal       Decimal?               // se fija al PROCESAR
  amountLocal       Decimal                // positivo; en PROVISION: + provisión / - liberación

  createdBy   Int?
  createdAt   DateTime @default(now())

  @@index([periodId], name: "ix_cl_period")
  @@index([accountingPeriodId], name: "ix_cl_accounting_period")
  @@index([type, state], name: "ix_cl_type_state")
  @@index([supportId, accountingPeriodId], name: "ix_cl_support_accounting_period")
}

model OC {
  id                     Int       @id @default(autoincrement())
  
  budgetPeriodFromId     Int
  budgetPeriodFrom       Period    @relation("OC_PERIOD_FROM", fields: [budgetPeriodFromId], references: [id])
  
  budgetPeriodToId       Int
  budgetPeriodTo         Period    @relation("OC_PERIOD_TO", fields: [budgetPeriodToId], references: [id])
  
  incidenteOc            String?
  solicitudOc            String?
  fechaRegistro          DateTime  @default(now())
  
  supportId              Int
  support                Support   @relation(fields: [supportId], references: [id], onDelete: Cascade)
  
  periodoEnFechasText    String?
  descripcion            String?   @db.Text
  
  // NUEVO: Relación con Usuario (solicitante)
  solicitanteUserId      Int?
  solicitanteUser        User?      @relation("OC_SOLICITANTE", fields: [solicitanteUserId], references: [id], onDelete: SetNull)
  
  // DEPRECATED: campos legacy (mantener para compatibilidad/migración)
  nombreSolicitante      String?    // Usar solicitanteUser.name
  correoSolicitante      String?    // Usar solicitanteUser.email
  proveedor              String?    // Usar proveedorRef.razonSocial
  ruc                    String?    // Usar proveedorRef.ruc
  
  // NUEVO: Relación con entidad Proveedor
  proveedorId            Int?
  proveedorRef           Proveedor? @relation("OC_PROVEEDOR", fields: [proveedorId], references: [id])
  
  moneda                 String    // PEN | USD
  importeSinIgv          Decimal
  
  estado                 OcStatus  @default(PENDIENTE)
  numeroOc               String?   @unique
  comentario             String?   @db.Text
  
  articuloId             Int?
  articulo               Articulo? @relation(fields: [articuloId], references: [id])
  
  cecoId                 Int?  // DEPRECATED: usar costCenters (M:N)
  ceco                   CostCenter? @relation("LegacyOCCostCenter", fields: [cecoId], references: [id])
  
  linkCotizacion         String?
  
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  
  // Relaciones
  invoices               Invoice[]
  costCenters            OCCostCenter[]  // M:N con CostCenter
  statusHistory          OCStatusHistory[]  // Historial de cambios de estado
  documents              OCDocument[]  // M:N con Document
  recursosTercerizados   RecursoTercOC[]  // M:N con RecursoTercerizado
  
  @@index([supportId], name: "ix_oc_support")
  @@index([estado], name: "ix_oc_estado")
  @@index([fechaRegistro], name: "ix_oc_fecha_registro")
  @@index([proveedorId], name: "ix_oc_proveedor")
  @@index([solicitanteUserId], name: "ix_oc_solicitante")
}

model SupportCostCenter {
  id           Int        @id @default(autoincrement())
  supportId    Int
  support      Support    @relation(fields: [supportId], references: [id], onDelete: Cascade)
  costCenterId Int
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([supportId, costCenterId], name: "ux_support_costcenter_pair")
  @@index([supportId], name: "ix_supportcostcenter_support")
  @@index([costCenterId], name: "ix_supportcostcenter_costcenter")
}

model OCCostCenter {
  id           Int        @id @default(autoincrement())
  ocId         Int
  oc           OC         @relation(fields: [ocId], references: [id], onDelete: Cascade)
  costCenterId Int
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([ocId, costCenterId], name: "ux_oc_costcenter_pair")
  @@index([ocId], name: "ix_occostcenter_oc")
  @@index([costCenterId], name: "ix_occostcenter_costcenter")
}

model OCStatusHistory {
  id        Int       @id @default(autoincrement())
  ocId      Int
  oc        OC        @relation(fields: [ocId], references: [id], onDelete: Cascade)
  status    OcStatus
  changedAt DateTime  @default(now())
  changedBy Int?
  note      String?

  @@index([ocId], name: "ix_ocstatushistory_oc")
  @@index([changedAt], name: "ix_ocstatushistory_changed_at")
}

// ============ DOCUMENTOS / ADJUNTOS ============

model Document {
  id              Int              @id @default(autoincrement())
  
  // Identificación en Google Drive
  driveFileId     String           @unique  // ID del archivo en Google Drive
  driveFolderId   String?                   // Carpeta actual en Drive
  
  // Metadatos del archivo
  filename        String                    // Nombre original del archivo
  mimeType        String                    // application/pdf, etc.
  sizeBytes       Int?                      // Tamaño en bytes
  
  // Categorización
  category        DocumentCategory @default(COTIZACION)
  
  // Trazabilidad
  uploadedBy      Int?                      // ID del usuario que subió
  uploadedAt      DateTime         @default(now())
  
  // Relaciones
  ocDocuments     OCDocument[]              // M:N con OC
  
  @@index([driveFileId], name: "ix_document_drive_file")
  @@index([category], name: "ix_document_category")
}

model OCDocument {
  id          Int       @id @default(autoincrement())
  ocId        Int
  oc          OC        @relation(fields: [ocId], references: [id], onDelete: Cascade)
  documentId  Int
  document    Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())

  @@unique([ocId, documentId], name: "ux_oc_document_pair")
  @@index([ocId], name: "ix_ocdocument_oc")
  @@index([documentId], name: "ix_ocdocument_document")
}

model Provision {
  id               Int       @id @default(autoincrement())
  sustentoId       Int
  sustento         Support   @relation(fields: [sustentoId], references: [id], onDelete: Cascade)
  periodoPpto      String    // Formato YYYY-MM (mes del presupuesto al que afecta)
  periodoContable  String    // Formato YYYY-MM (mes contable del cierre)
  montoPen         Decimal   // Monto en soles (positivo=provisión, negativo=liberación/extorno)
  detalle          String?   @db.Text
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([sustentoId], name: "ix_provision_sustento")
  @@index([periodoPpto], name: "ix_provision_periodo_ppto")
  @@index([periodoContable], name: "ix_provision_periodo_contable")
}

// ============ CONTRATOS - RECURSOS TERCERIZADOS ============

enum RecursoStatus {
  ACTIVO
  CESADO
}

model RecursoTercerizado {
  id                 Int              @id @default(autoincrement())
  
  // Datos de la persona
  nombreCompleto     String           // Nombre completo de la persona tercerizada
  cargo              String           // Cargo que desempeña
  
  // Relación con Gerencia TI (requerido)
  managementId       Int
  management         Management       @relation(fields: [managementId], references: [id], onDelete: Restrict)
  
  // Relación con Persona Responsable (requerido)
  responsableId      Int
  responsable        User             @relation(fields: [responsableId], references: [id], onDelete: Restrict)
  
  // Relación con Proveedor (requerido)
  proveedorId        Int
  proveedor          Proveedor        @relation(fields: [proveedorId], references: [id], onDelete: Restrict)
  
  // Relación con Sustento (opcional, para tracking presupuestario)
  supportId          Int?
  support            Support?         @relation(fields: [supportId], references: [id], onDelete: SetNull)
  
  // Datos del contrato vigente
  fechaInicio        DateTime         // Fecha de inicio del contrato vigente
  fechaFin           DateTime         // Fecha de fin del contrato vigente (también es la fecha de cese)
  montoMensual       Decimal          // Monto mensual en soles (PEN)
  
  // Link al contrato/cotización vigente (editable)
  linkContrato       String?          @db.Text
  
  // Estado (calculado en lógica: CESADO si fechaFin < hoy, ACTIVO en caso contrario)
  status             RecursoStatus    @default(ACTIVO)
  
  // Observaciones/notas
  observaciones      String?          @db.Text
  
  // Auditoría
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  createdBy          Int?
  
  // Relaciones many-to-many
  ocs                RecursoTercOC[]  // Múltiples OCs asociadas
  historico          HistoricoContrato[]
  
  @@index([managementId], name: "ix_recurso_management")
  @@index([responsableId], name: "ix_recurso_responsable")
  @@index([proveedorId], name: "ix_recurso_proveedor")
  @@index([supportId], name: "ix_recurso_support")
  @@index([status], name: "ix_recurso_status")
  @@index([fechaFin], name: "ix_recurso_fecha_fin")
}

// Tabla de unión para relación many-to-many entre RecursoTercerizado y OC
model RecursoTercOC {
  id              Int                @id @default(autoincrement())
  recursoTercId   Int
  recursoTerc     RecursoTercerizado @relation(fields: [recursoTercId], references: [id], onDelete: Cascade)
  ocId            Int
  oc              OC                 @relation(fields: [ocId], references: [id], onDelete: Cascade)
  createdAt       DateTime           @default(now())
  
  @@unique([recursoTercId, ocId])
  @@index([recursoTercId], name: "ix_recurso_terc_oc_recurso")
  @@index([ocId], name: "ix_recurso_terc_oc_oc")
}

model HistoricoContrato {
  id                  Int                @id @default(autoincrement())
  recursoTercId       Int
  recursoTerc         RecursoTercerizado @relation(fields: [recursoTercId], references: [id], onDelete: Cascade)
  
  // Datos del contrato histórico (snapshot de fechas y monto en ese período)
  fechaInicio         DateTime
  fechaFin            DateTime  // Fecha de fin = fecha de cese del contrato
  montoMensual        Decimal
  linkContrato        String?            @db.Text
  
  // Auditoría
  createdAt           DateTime           @default(now())
  
  @@index([recursoTercId], name: "ix_historico_recurso")
  @@index([fechaInicio, fechaFin], name: "ix_historico_periodo")
}

// ============ AUTENTICACIÓN Y ROLES ============

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  name          String?
  googleId      String?   @unique
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  userRoles     UserRole[]
  recursosTercerizados RecursoTercerizado[]
  invoicesCreated   Invoice[] @relation("InvoiceCreatedBy")
  invoicesApproved  Invoice[] @relation("InvoiceApprovedBy")
  ocsSolicitante    OC[]      @relation("OC_SOLICITANTE")
  
  @@index([email], name: "ix_user_email")
}

model Role {
  id            Int       @id @default(autoincrement())
  name          String    @unique
  description   String?
  isSystem      Boolean   @default(false)  // true para super_admin (no se puede eliminar)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  userRoles     UserRole[]
  permissions   RolePermission[]
  
  @@index([name], name: "ix_role_name")
}

model Permission {
  id            Int       @id @default(autoincrement())
  key           String    @unique  // Ej: 'dashboard', 'ocs', 'ocs:listado', 'ocs:gestion', etc.
  name          String    // Nombre descriptivo: 'Dashboard', 'Órdenes de Compra', etc.
  description   String?
  module        String?   // Módulo al que pertenece (para agrupar en UI): 'ocs', 'facturas', etc.
  parentKey     String?   // Key del permiso padre (para jerarquía): 'ocs' es padre de 'ocs:listado'
  sortOrder     Int       @default(0)  // Orden de visualización en UI
  
  roles         RolePermission[]
  
  @@index([key], name: "ix_permission_key")
  @@index([module], name: "ix_permission_module")
  @@index([parentKey], name: "ix_permission_parent")
}

model UserRole {
  id            Int       @id @default(autoincrement())
  userId        Int
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId        Int
  role          Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  
  @@unique([userId, roleId], name: "ux_user_role")
  @@index([userId], name: "ix_userrole_user")
  @@index([roleId], name: "ix_userrole_role")
}

model RolePermission {
  id            Int       @id @default(autoincrement())
  roleId        Int
  role          Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId  Int
  permission    Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  
  @@unique([roleId, permissionId], name: "ux_role_permission")
  @@index([roleId], name: "ix_rolepermission_role")
  @@index([permissionId], name: "ix_rolepermission_permission")
}
