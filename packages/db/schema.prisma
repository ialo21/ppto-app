generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ClType { 
  PPTO 
  RPPTO 
  GASTO 
  PROVISION 
}

enum ClState { 
  NO_PROCESADO 
  PROCESADO 
  PROVISIONADO 
}

enum InvStatus {
  INGRESADO 
  EN_APROBACION 
  EN_CONTABILIDAD 
  EN_TESORERIA 
  EN_ESPERA_DE_PAGO 
  PAGADO 
  RECHAZADO
}

enum InvDocType { 
  FACTURA 
  NOTA_CREDITO 
}

enum ExpenseType {
  ADMINISTRATIVO
  PRODUCTO
  DISTRIBUIBLE
}

enum OcStatus {
  PENDIENTE
  PROCESAR
  PROCESADO
  APROBACION_VP
  ANULAR
  ANULADO
  ATENDER_COMPRAS
  ATENDIDO
}

model Period {
  id      Int     @id @default(autoincrement())
  year    Int
  month   Int
  label   String?
  // relaciones
  controlLines_period        ControlLine[] @relation("CL_PERIOD")
  controlLines_accountPeriod ControlLine[] @relation("CL_ACCOUNTING_PERIOD")
  closures AccountingClosure?
  budgetAllocations BudgetAllocation[]
  oc_periodFrom OC[] @relation("OC_PERIOD_FROM")
  oc_periodTo   OC[] @relation("OC_PERIOD_TO")
}

model AccountingClosure {
  id         Int     @id @default(autoincrement())
  periodId   Int     @unique
  period     Period  @relation(fields: [periodId], references: [id])
  receivedAt DateTime?
  sourceRef  String?
}

model FxReference {
  id            Int      @id @default(autoincrement())
  currency      String   // 'PEN' | 'USD'
  rate          Decimal
  effectiveFrom DateTime
  effectiveTo   DateTime?
}

model Support {
  id               Int      @id @default(autoincrement())
  code             String?  @unique
  name             String   @unique
  management       String?  // DEPRECATED: usar managementId
  area             String?  // DEPRECATED: usar areaId
  active           Boolean  @default(true)

  managementId     Int?
  managementRef    Management?        @relation(fields: [managementId], references: [id])

  areaId           Int?
  areaRef          Area?              @relation(fields: [areaId], references: [id])

  costCenterId     Int?  // DEPRECATED: usar costCenters (M:N)
  costCenter       CostCenter?        @relation("LegacySupportCostCenter", fields: [costCenterId], references: [id])

  expensePackageId Int?
  expensePackage   ExpensePackage?    @relation(fields: [expensePackageId], references: [id])

  expenseConceptId Int?
  expenseConcept   ExpenseConcept?    @relation(fields: [expenseConceptId], references: [id])

  expenseType      ExpenseType @default(ADMINISTRATIVO)

  vendorId         Int?

  // relaciones
  budgetAllocations BudgetAllocation[]
  controlLines      ControlLine[]
  ocs               OC[]
  costCenters       SupportCostCenter[]  // M:N con CostCenter
}

model CostCenter {
  id       Int       @id @default(autoincrement())
  code     String    @unique
  name     String?
  supports Support[] @relation("LegacySupportCostCenter")  // DEPRECATED: relación 1:N legacy
  ocs      OC[]
  supportLinks SupportCostCenter[]  // M:N con Support
  budgetAllocations BudgetAllocation[]
}

model Articulo {
  id   Int    @id @default(autoincrement())
  code String @unique
  name String
  ocs  OC[]
}

model Management {
  id       Int       @id @default(autoincrement())
  code     String?   // DEPRECATED: usar name directamente
  name     String    // Unicidad case-insensitive via índice
  active   Boolean   @default(true)
  supports Support[]
  areas    Area[]
}

model Area {
  id           Int         @id @default(autoincrement())
  code         String?     // DEPRECATED: usar name directamente
  name         String      // Unicidad case-insensitive via índice
  managementId Int
  management   Management  @relation(fields: [managementId], references: [id], onDelete: Cascade)
  active       Boolean     @default(true)
  supports     Support[]
}

model ExpensePackage {
  id        Int              @id @default(autoincrement())
  name      String
  supports  Support[]
  concepts  ExpenseConcept[]
}

model ExpenseConcept {
  id        Int             @id @default(autoincrement())
  name      String
  packageId Int
  package   ExpensePackage  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  supports  Support[]
}

model BudgetVersion {
  id     Int     @id @default(autoincrement())
  name   String
  status String   // 'ACTIVE' | 'DRAFT' | 'ARCHIVED'
  allocs BudgetAllocation[]
}

model BudgetAllocation {
  id           Int     @id @default(autoincrement())
  versionId    Int
  version      BudgetVersion @relation(fields: [versionId], references: [id])
  supportId    Int
  support      Support @relation(fields: [supportId], references: [id], onDelete: Cascade)
  costCenterId Int?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id], onDelete: Cascade)
  periodId     Int
  period       Period  @relation(fields: [periodId], references: [id])
  amountLocal  Decimal
  currency     String  @default("PEN")

  @@unique([versionId, periodId, supportId, costCenterId], name: "ux_alloc_version_period_support_ceco")
  @@index([periodId, costCenterId], name: "ix_alloc_period_ceco")
}

model Vendor {
  id        Int     @id @default(autoincrement())
  legalName String
  taxId     String? @unique
  // relaciones
  purchaseOrders PurchaseOrder[]
  invoices       Invoice[]
}

model PurchaseOrder {
  id       Int     @id @default(autoincrement())
  number   String  @unique
  vendorId Int?
  vendor   Vendor? @relation(fields: [vendorId], references: [id])
  incCode  String?
  // relaciones
  controlLines ControlLine[]
}

model Invoice {
  id              Int        @id @default(autoincrement())
  
  // NUEVO: Relación con OC (requerido para nuevas facturas)
  ocId            Int?
  oc              OC?        @relation(fields: [ocId], references: [id], onDelete: SetNull)
  
  // DEPRECATED: vendorId ahora se deriva de OC
  vendorId        Int?
  vendor          Vendor?    @relation(fields: [vendorId], references: [id])
  
  docType         InvDocType @default(FACTURA)
  numberNorm      String?
  
  // Moneda se hereda de la OC
  currency        String     @default("PEN")  // 'PEN' | 'USD'
  
  // NUEVO: Monto principal (sin IGV)
  montoSinIgv     Decimal?
  
  // DEPRECATED: campos legacy (mantener para compatibilidad)
  totalForeign    Decimal?   // negativo si NOTA_CREDITO
  totalLocal      Decimal?   // negativo si NOTA_CREDITO
  
  statusCurrent   InvStatus  @default(INGRESADO)
  ultimusIncident String?    // Incidente Ultimus
  detalle         String?    @db.Text
  approvedAt      DateTime?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  statusHistory   InvoiceStatusHistory[]
  controlLines    ControlLine[]
  
  @@index([ocId], name: "ix_invoice_oc")
}

model InvoiceStatusHistory {
  id        Int       @id @default(autoincrement())
  invoiceId Int
  invoice   Invoice   @relation(fields: [invoiceId], references: [id])
  status    InvStatus
  changedAt DateTime  @default(now())
  changedBy Int?
  note      String?
}

model ControlLine {
  id        Int      @id @default(autoincrement())
  supportId Int
  support   Support  @relation(fields: [supportId], references: [id], onDelete: Cascade)

  type  ClType
  state ClState @default(NO_PROCESADO)

  periodId Int
  period   Period @relation("CL_PERIOD", fields: [periodId], references: [id])

  accountingPeriodId Int?
  accountingPeriod   Period? @relation("CL_ACCOUNTING_PERIOD", fields: [accountingPeriodId], references: [id])

  invoiceId Int?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])

  poId Int?
  po   PurchaseOrder? @relation(fields: [poId], references: [id])

  description   String?

  // Moneda y TC
  currency          String?      // 'PEN' | 'USD'
  amountForeign     Decimal?
  fxRateProvisional Decimal? @default(1.0) // asignada al crear (USD usa FxReference; PEN=1)
  fxRateFinal       Decimal?               // se fija al PROCESAR
  amountLocal       Decimal                // positivo; en PROVISION: + provisión / - liberación

  createdBy   Int?
  createdAt   DateTime @default(now())

  @@index([periodId], name: "ix_cl_period")
  @@index([accountingPeriodId], name: "ix_cl_accounting_period")
  @@index([type, state], name: "ix_cl_type_state")
  @@index([supportId, accountingPeriodId], name: "ix_cl_support_accounting_period")
}

model OC {
  id                     Int       @id @default(autoincrement())
  
  budgetPeriodFromId     Int
  budgetPeriodFrom       Period    @relation("OC_PERIOD_FROM", fields: [budgetPeriodFromId], references: [id])
  
  budgetPeriodToId       Int
  budgetPeriodTo         Period    @relation("OC_PERIOD_TO", fields: [budgetPeriodToId], references: [id])
  
  incidenteOc            String?
  solicitudOc            String?
  fechaRegistro          DateTime  @default(now())
  
  supportId              Int
  support                Support   @relation(fields: [supportId], references: [id], onDelete: Cascade)
  
  periodoEnFechasText    String?
  descripcion            String?   @db.Text
  nombreSolicitante      String
  correoSolicitante      String
  
  proveedor              String
  ruc                    String
  
  moneda                 String    // PEN | USD
  importeSinIgv          Decimal
  
  estado                 OcStatus  @default(PENDIENTE)
  numeroOc               String?   @unique
  comentario             String?   @db.Text
  
  articuloId             Int?
  articulo               Articulo? @relation(fields: [articuloId], references: [id])
  
  cecoId                 Int?
  ceco                   CostCenter? @relation(fields: [cecoId], references: [id])
  
  linkCotizacion         String?
  
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  
  // NUEVO: Relación con Facturas
  invoices               Invoice[]
  
  @@index([supportId], name: "ix_oc_support")
  @@index([estado], name: "ix_oc_estado")
  @@index([fechaRegistro], name: "ix_oc_fecha_registro")
}

model SupportCostCenter {
  id           Int        @id @default(autoincrement())
  supportId    Int
  support      Support    @relation(fields: [supportId], references: [id], onDelete: Cascade)
  costCenterId Int
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([supportId, costCenterId], name: "ux_support_costcenter_pair")
  @@index([supportId], name: "ix_supportcostcenter_support")
  @@index([costCenterId], name: "ix_supportcostcenter_costcenter")
}
